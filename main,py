from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, InputMediaPhoto, KeyboardButton, ReplyKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ConversationHandler, CallbackContext, CallbackQueryHandler
import os
import json
import requests
from amocrm.v2 import Lead as _Lead, tokens, Pipeline, custom_field

from config import Config

CATEGORY, SUBCATEGORY, OTHER_SUBCATEGORY, CONFIRM_SUBCATEGORY, SIZE_KNOWN, LENGTH, WIDTH, GLASS, COLOR, OTHER_COLOR, CONFIRM_COLOR, VISUAL, SOURCE, OTHER_SOURCE, CONFIRM_SOURCE, PHONE_NUMBER, COMPLETE, CONFIRM_ORDER = range(18)

CATEGORIES = {
    "ÐŸÐµÑ€ÐµÐ³Ð¾Ñ€Ð¾Ð´ÐºÐ°": ["Ð¡Ñ‚Ð°Ñ†Ð¸Ð¾Ð½Ð°Ñ€Ð½Ð°Ñ", "Ð Ð°ÑÐ¿Ð°ÑˆÐ½Ð°Ñ", "ÐžÑ‚ÐºÐ°Ñ‚Ð½Ð°Ñ", "ÐšÐ°ÑÐºÐ°Ð´Ð½Ð°Ñ", "Ð“Ð°Ñ€Ð¼Ð¾ÑˆÐºÐ°", "Ð‘ÐµÐ·Ñ€Ð°Ð¼Ð¾Ñ‡Ð½Ð°Ñ"],
    "Ð§Ð°ÑˆÐ°": [],
    "Ð¡Ñ‚ÐµÐ»Ð»Ð°Ð¶": [],
    "Ð—ÐµÑ€ÐºÐ°Ð»Ð¾": []
}

GLASS_OPTIONS = ["ÐœÐ°Ñ‚Ð¾Ð²Ð¾Ðµ", "ÐŸÑ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ð¾Ðµ", "Ð Ð¸Ñ„Ð»ÐµÐ½Ð¾Ðµ", "Ð¢Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ðµ"]
COLOR_OPTIONS = ["Ð§ÐµÑ€Ð½Ñ‹Ð¹", "Ð‘ÐµÐ»Ñ‹Ð¹", "Ð—Ð¾Ð»Ð¾Ñ‚Ð¾Ð¹"]
SOURCE_OPTIONS = ["Ð¤Ð°Ñ€Ð¿Ð¾ÑÑ‚", "Ð˜Ð½ÑÑ‚Ð°Ð³Ñ€Ð°Ð¼", "Ð”Ð¸Ð·Ð°Ð¹Ð½ÐµÑ€", "ÐŸÐ¾ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸"]

PHOTOS = [
    {"path": f"{i}.jpg", "caption": f"ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ: {cat}"}
    for i, cat in zip(range(1, 19), [
        *["ÐšÐ°ÑÐºÐ°Ð´Ð½Ð°Ñ"] * 4,
        *["Ð“Ð°Ñ€Ð¼Ð¾ÑˆÐºÐ°"] * 3,
        *["Ð Ð°ÑÐ¿Ð°ÑˆÐ½Ð°Ñ"] * 2,
        *["ÐžÑ‚ÐºÐ°Ñ‚Ð½Ð°Ñ"] * 4,
        *["Ð‘ÐµÐ·Ñ€Ð°Ð¼Ð¾Ñ‡Ð½Ð°Ñ"] * 2,
        *["Ð¡Ñ‚Ð°Ñ†Ð¸Ð¾Ð½Ð°Ñ€Ð½Ð°Ñ"] * 3
    ])
]

# Ñ‚Ð¾ÐºÐµÐ½Ñ‹ AmoCRM

def load_tokens():
    if os.path.exists(Config.TOKEN_FILE):
        with open(Config.TOKEN_FILE, "r") as file:
            return json.load(file)
    return None

def save_tokens(tokens_data):
    with open(Config.TOKEN_FILE, "w") as file:
        json.dump(tokens_data, file)

def refresh_tokens():
    tokens_data = load_tokens()
    if not tokens_data:
        print("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²")
        return None

    response = requests.post(
        f"https://{Config.SUBDOMAIN}.amocrm.ru/oauth2/access_token",
        json={
            "client_id": Config.CLIENT_ID,
            "client_secret": Config.CLIENT_SECRET,
            "grant_type": "refresh_token",
            "refresh_token": tokens_data["refresh_token"],
            "redirect_uri": Config.REDIRECT_URI
        }
    )

    if response.status_code == 200:
        new_tokens = response.json()
        save_tokens(new_tokens)
        return new_tokens["access_token"]
    else:
        print("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²")
        return None

def get_access_token():
    tokens_data = load_tokens()
    if not tokens_data:
        print("âŒ Ð¢Ð¾ÐºÐµÐ½Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹")
        return None
    return tokens_data.get("access_token") or refresh_tokens()

async def main_menu(update: Update, context: CallbackContext):
    
    context.user_data.clear()

    if update.message and update.message.text == "/start":
        welcome_text = (
            "ðŸ‘‹ Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ! Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾, Ñ‡Ñ‚Ð¾ Ð²Ñ‹Ð±Ñ€Ð°Ð»Ð¸ Ð½Ð°ÑˆÑƒ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸ÑŽ. ÐÐ° ÑÐ²ÑÐ·Ð¸ Ð±Ð¾Ñ‚ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸ Svarka&Design. ðŸŒŸ\n\n"
            "Ð¯ Ð³Ð¾Ñ‚Ð¾Ð² Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ð²Ð°Ð¼ Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð¾Ð¼ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð°, Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚ Ð¸ Ñ€Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ.\n\n"
            "âœ¨ Ð§Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð·Ð²Ð°Ñ‚ÑŒ Ð¼ÐµÐ½ÑŽ Ð² Ð»ÑŽÐ±Ð¾Ð¹ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚, Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ:\n"
            "- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ /menu\n"
            "- ÐÐ°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð² Ñ‡Ð°Ñ‚ ÑÐ»Ð¾Ð²Ð¾ \"Ð¼ÐµÐ½ÑŽ\"\n\n"
            "ÐœÑ‹ Ð²ÑÐµÐ³Ð´Ð° Ñ€ÑÐ´Ð¾Ð¼, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ Ð²Ð°Ñˆ Ð¾Ð¿Ñ‹Ñ‚ Ð¿Ñ€Ð¸ÑÑ‚Ð½Ñ‹Ð¼ Ð¸ ÑƒÐ´Ð¾Ð±Ð½Ñ‹Ð¼! ðŸ˜Š"
        ) 
        await update.message.reply_text(welcome_text)

    keyboard = [
        [InlineKeyboardButton("ðŸ“ Ð—ÐÐšÐÐ—ÐÐ¢Ð¬ Ð ÐÐ¡Ð§ÐÐ¢", callback_data='order')],
        [InlineKeyboardButton("ðŸ–¼ï¸ ÐŸÐ¾Ñ€Ñ‚Ñ„Ð¾Ð»Ð¸Ð¾", callback_data='gallery')],
        [InlineKeyboardButton("ðŸ¢ Ðž ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸", callback_data='about')],
        [InlineKeyboardButton("ðŸ“ž ÐžÐ±Ñ€Ð°Ñ‚Ð½Ð°Ñ ÑÐ²ÑÐ·ÑŒ", callback_data='feedback')],
        [InlineKeyboardButton("ðŸ›  Ð¢ÐµÑ…Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°", callback_data='support')], 
        [InlineKeyboardButton("â“ FAQ", callback_data='faq')],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if update.callback_query:
        await update.callback_query.edit_message_text("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ€Ð°Ð·Ð´ÐµÐ»:", reply_markup=reply_markup)
    else:
        await update.message.reply_text("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ€Ð°Ð·Ð´ÐµÐ»:", reply_markup=reply_markup)

    return ConversationHandler.END

# Ðž ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸
async def about_company(update: Update, context: CallbackContext):
    query = update.callback_query
    await query.answer()

    about_text = (
        "ðŸŒŸ *Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¼ÐµÑ‚Ð°Ð»Ð»Ð¾ÐºÐ¾Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÑŽÑ‚!*\n\n"
        "ÐœÑ‹ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ÑÑ Ð½Ð° Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´ÑÑ‚Ð²Ðµ:\n"
        "ðŸ”¹ *Ð¡Ñ‚Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¿ÐµÑ€ÐµÐ³Ð¾Ñ€Ð¾Ð´Ð¾Ðº* â€” Ð´Ð»Ñ Ð·Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÑÑ‚Ð²Ð° Ñ ÑÑÑ‚ÐµÑ‚Ð¸ÐºÐ¾Ð¹ Ð¸ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒÑŽ.\n"
        "ðŸ”¹ *ÐšÐ¾ÑÑ‚Ñ€Ð¾Ð²Ñ‹Ñ… Ñ‡Ð°Ñˆ* â€” ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ‚Ð¼Ð¾ÑÑ„ÐµÑ€Ñƒ ÑƒÑŽÑ‚Ð° Ð¸ Ñ‚ÐµÐ¿Ð»Ð° Ð´Ð»Ñ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð´Ð¾Ð¼Ð° Ð¸Ð»Ð¸ Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ð°.\n"
        "ðŸ”¹ *Ð­ÐºÑÐºÐ»ÑŽÐ·Ð¸Ð²Ð½Ñ‹Ñ… Ð·ÐµÑ€ÐºÐ°Ð»* â€” Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð·Ñ‹ÑÐºÐ°Ð½Ð½Ð¾ÑÑ‚Ð¸ Ð»ÑŽÐ±Ð¾Ð¼Ñƒ Ð¸Ð½Ñ‚ÐµÑ€ÑŒÐµÑ€Ñƒ.\n"
        "ðŸ”¹ *Ð›ÐµÐµÑ€Ð½Ñ‹Ñ… Ð¾Ð³Ñ€Ð°Ð¶Ð´ÐµÐ½Ð¸Ð¹ Ð¸ Ð»ÐµÑÑ‚Ð½Ð¸Ñ†* â€” ÑÐ¾Ñ‡ÐµÑ‚Ð°Ð½Ð¸Ðµ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸, Ð½Ð°Ð´ÐµÐ¶Ð½Ð¾ÑÑ‚Ð¸ Ð¸ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð´Ð¸Ð·Ð°Ð¹Ð½Ð°.\n\n"
        "âœ¨ *ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÑŽÑ‚ Ð½Ð°Ñ?*\n"
        "âœ… *ÐŸÐ¾Ñ€Ð¾ÑˆÐºÐ¾Ð²Ð¾-Ð¿Ð¾Ð»Ð¸Ð¼ÐµÑ€Ð½Ð°Ñ Ð¿Ð¾ÐºÑ€Ð°ÑÐºÐ°* â€” Ð´Ð¾Ð»Ð³Ð¾Ð²ÐµÑ‡Ð½Ð¾ÑÑ‚ÑŒ Ð¸ Ð±ÐµÐ·ÑƒÐ¿Ñ€ÐµÑ‡Ð½Ñ‹Ð¹ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¹ Ð²Ð¸Ð´.\n"
        "âœ… *Ð˜Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾Ð´Ñ…Ð¾Ð´* â€” ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚ ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ÑÑ Ñ ÑƒÑ‡ÐµÑ‚Ð¾Ð¼ Ð²Ð°ÑˆÐ¸Ñ… Ð¿Ð¾Ð¶ÐµÐ»Ð°Ð½Ð¸Ð¹.\n"
        "âœ… *ÐžÐ¿Ñ‹Ñ‚ Ð¸ Ñ€ÐµÐ¿ÑƒÑ‚Ð°Ñ†Ð¸Ñ* â€” 7 Ð»ÐµÑ‚ Ð½Ð° Ñ€Ñ‹Ð½ÐºÐµ Ð”Ð°Ð»ÑŒÐ½ÐµÐ³Ð¾ Ð’Ð¾ÑÑ‚Ð¾ÐºÐ°, ÑÐ¾Ñ‚Ð½Ð¸ Ð´Ð¾Ð²Ð¾Ð»ÑŒÐ½Ñ‹Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð².\n\n"
        "ðŸ† *ÐÐ°ÑˆÐ¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð³Ð¾Ð²Ð¾Ñ€ÑÑ‚ Ð·Ð° Ð½Ð°Ñ:*\n"
        "ÐœÑ‹ Ð³Ð¾Ñ€Ð´Ð¸Ð¼ÑÑ Ñ‚ÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð½Ð°ÑˆÐ¸ Ð¸Ð·Ð´ÐµÐ»Ð¸Ñ ÑƒÐºÑ€Ð°ÑˆÐ°ÑŽÑ‚ Ñ‚Ð°ÐºÐ¸Ðµ Ð¾Ð±ÑŠÐµÐºÑ‚Ñ‹, ÐºÐ°Ðº:\n"
        "â€¢ Vladivostok International Airport\n"
        "â€¢ UMAMI\n"
        "â€¢ ÐŸÐ¾ÑÐ¾Ð»ÑŒÑÑ‚Ð²Ð¾ ÐšÑ€Ð°ÑÐ¾Ñ‚Ñ‹\n"
        "â€¢ Ð“ÐµÐ¾Ð¼ÐµÑ‚Ñ€Ð¸Ñ Ñ„Ð¸Ñ‚Ð½ÐµÑÐ°\n"
        "â€¢ ZUMA\n"
        "â€¢ CEDRA\n"
        "â€¢ Vladivostok Design Week\n"
        "â€¢ VVO Apartments Group\n\n"
        "ðŸ’Ž *Svarka&Design* â€” ÑÑ‚Ð¾ Ð½Ðµ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¼ÐµÑ‚Ð°Ð»Ð»Ð¾ÐºÐ¾Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸, ÑÑ‚Ð¾ Ð¸ÑÐºÑƒÑÑÑ‚Ð²Ð¾, Ð²Ð¾Ð¿Ð»Ð¾Ñ‰ÐµÐ½Ð½Ð¾Ðµ Ð² Ð¼ÐµÑ‚Ð°Ð»Ð»Ðµ.\n"
        "Ð”Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð½Ð°Ð¼ Ð²Ð°Ñˆ Ð¿Ñ€Ð¾ÐµÐºÑ‚, Ð¸ Ð¼Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð´Ð¸Ð¼ Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð°Ð½ÐµÑ‚ Ð²Ð°ÑˆÐµÐ¹ Ð³Ð¾Ñ€Ð´Ð¾ÑÑ‚ÑŒÑŽ!\n"
    )

    keyboard = [
        [InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(
        about_text,
        reply_markup=reply_markup,
        parse_mode="Markdown"
    )

current_photo_index = 0

async def gallery(update: Update, context: CallbackContext):
    global current_photo_index
    current_photo_index = 0
    await show_photo(update, context)

async def show_photo(update: Update, context: CallbackContext):
    global current_photo_index
    photo = PHOTOS[current_photo_index]

    keyboard = [
        [
            InlineKeyboardButton("â¬…ï¸ ÐÐ°Ð·Ð°Ð´", callback_data='prev_photo'),
            InlineKeyboardButton("âž¡ï¸ Ð’Ð¿ÐµÑ€ÐµÐ´", callback_data='next_photo')
        ],
        [InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´ Ð² Ð¼ÐµÐ½ÑŽ", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    if 'photo_message_id' in context.user_data:
        try:
            await context.bot.edit_message_media(
                chat_id=update.callback_query.message.chat_id,
                message_id=context.user_data['photo_message_id'],
                media=InputMediaPhoto(media=open(photo['path'], 'rb'), caption=photo['caption']),
                reply_markup=reply_markup
            )
        except Exception as e:
            print("âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° ÐºÐ°ÐºÐ°Ñ-Ñ‚Ð¾ Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð¼ [Ð² Telegram](https://t.me/+79953969908) Ð¾Ð± ÑÑ‚Ð¾Ð¼!!")
    else:

        message = await update.callback_query.message.reply_photo(
            photo=open(photo['path'], 'rb'),
            caption=photo['caption'],
            reply_markup=reply_markup
        )
        context.user_data['photo_message_id'] = message.message_id

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð´Ð»Ñ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ñ„Ð¾Ñ‚Ð¾Ð³Ñ€Ð°Ñ„Ð¸ÑÐ¼
async def handle_photo_navigation(update: Update, context: CallbackContext):
    global current_photo_index
    query = update.callback_query
    await query.answer()

    if query.data == 'next_photo':
        current_photo_index += 1
        if current_photo_index >= len(PHOTOS):
            current_photo_index = 0
    elif query.data == 'prev_photo':
        current_photo_index -= 1
        if current_photo_index < 0:
            current_photo_index = len(PHOTOS) - 1
    elif query.data == 'back_to_main':
        if 'photo_message_id' in context.user_data:
            try:
                await context.bot.delete_message(
                    chat_id=query.message.chat_id,
                    message_id=context.user_data['photo_message_id']
                )
                del context.user_data['photo_message_id']
            except Exception as e:
                print("âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° ÐºÐ°ÐºÐ°Ñ-Ñ‚Ð¾ Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð¼ [Ð² Telegram](https://t.me/+79953969908) Ð¾Ð± ÑÑ‚Ð¾Ð¼!!")

        current_photo_index = 0

        await query.message.reply_text("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ€Ð°Ð·Ð´ÐµÐ»:", reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("ðŸ“ Ð—ÐÐšÐÐ—ÐÐ¢Ð¬ Ð ÐÐ¡Ð§ÐÐ¢", callback_data='order')],
            [InlineKeyboardButton("ðŸ–¼ï¸ ÐŸÐ¾Ñ€Ñ‚Ñ„Ð¾Ð»Ð¸Ð¾", callback_data='gallery')],
            [InlineKeyboardButton("ðŸ¢ Ðž ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸", callback_data='about')],
            [InlineKeyboardButton("ðŸ“ž ÐžÐ±Ñ€Ð°Ñ‚Ð½Ð°Ñ ÑÐ²ÑÐ·ÑŒ", callback_data='feedback')],
            [InlineKeyboardButton("ðŸ›  Ð¢ÐµÑ…Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°", callback_data='support')],
            [InlineKeyboardButton("â“ FAQ", callback_data='faq')],
        ]))
        return

    await show_photo(update, context)

# ÐžÐ±Ñ€Ð°Ñ‚Ð½Ð°Ñ ÑÐ²ÑÐ·ÑŒ
async def feedback(update: Update, context: CallbackContext):
    query = update.callback_query
    await query.answer()

    feedback_text = (
        "ðŸ“ž *Ð¡Ð²ÑÐ¶Ð¸Ñ‚ÐµÑÑŒ Ñ Ð½Ð°Ð¼Ð¸!*\n\n"
        "ðŸ”— *WhatsApp:* [+7 914 728 18 18](https://wa.me/79147281818)\n"
        "ðŸ“¸ *Instagram:* [@svarkavl](https://www.instagram.com/svarkavl)\n"
        "ðŸŒ *Ð¡Ð°Ð¹Ñ‚:* [svarka25.ru](https://svarka25.ru/)\n"
        "ðŸ“ *ÐœÑ‹ Ð² 2Ð“Ð˜Ð¡:* [ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð² 2Ð“Ð˜Ð¡](https://2gis.ru/vladivostok/geo/70000001076981081)\n\n"
        "ÐœÑ‹ Ð²ÑÐµÐ³Ð´Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ Ð½Ð° Ð²Ð°ÑˆÐ¸ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¸ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð¾Ð¼! ðŸ˜Š"
    )

    keyboard = [
        [InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(
        feedback_text,
        reply_markup=reply_markup,
        parse_mode="Markdown",
        disable_web_page_preview=False
    )

# FAQ
async def faq(update: Update, context: CallbackContext):
    query = update.callback_query
    await query.answer()

    faq_text = (
        "â“ *Ð§Ð°ÑÑ‚Ð¾ Ð·Ð°Ð´Ð°Ð²Ð°ÐµÐ¼Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹:*\n\n"
        "1. *ÐšÐ°Ðº Ð·Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ?*\n"
        "â€” ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² Ñ€Ð°Ð·Ð´ÐµÐ» Â«Ð—Ð°ÐºÐ°Ð· ÐšÐŸÂ», ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð²ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ, Ð¸ Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð´Ð½Ñ Ð¼Ñ‹ Ð²Ñ‹ÑˆÐ»ÐµÐ¼ Ð¿ÐµÑ€Ð²Ð¸Ñ‡Ð½Ð¾Ðµ ÐšÐŸ. Ð”Ð°Ð»ÐµÐµ Ñ Ð²Ð°Ð¼Ð¸ ÑÐ²ÑÐ¶ÐµÑ‚ÑÑ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€.\n\n"
        "2. *ÐšÐ°ÐºÐ¸Ðµ ÑÑ€Ð¾ÐºÐ¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ?*\n"
        "â€” 35 Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ñ… Ð´Ð½ÐµÐ¹ Ñ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð° Ð·Ð°Ð¼ÐµÑ€Ð° Ð¾Ð±ÑŠÐµÐºÑ‚Ð°.\n\n"
        "3. *ÐšÐ°Ðº Ð¾Ð¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð·?*\n"
        "â€” ÐŸÐ¾ÑÐ»Ðµ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ð¸Ñ ÐšÐŸ Ð¸ Ð·Ð°Ð¼ÐµÑ€Ð¾Ð² Ð½Ð° Ð¾Ð±ÑŠÐµÐºÑ‚Ðµ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ ÑÐ¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ Ð´Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð½Ð° Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ. ÐŸÑ€ÐµÐ´Ð¾Ð¿Ð»Ð°Ñ‚Ð° ÑÐ¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ 70%. Ð”Ð¾Ð¿Ð»Ð°Ñ‚Ð° â€” 30% Ð¿Ð¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹.\n\n"
        "Ð•ÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ Ð¾ÑÑ‚Ð°Ð»Ð¸ÑÑŒ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹, ÑÐ²ÑÐ¶Ð¸Ñ‚ÐµÑÑŒ Ñ Ð½Ð°Ð¼Ð¸ Ñ‡ÐµÑ€ÐµÐ· Ñ€Ð°Ð·Ð´ÐµÐ» Â«ÐžÐ±Ñ€Ð°Ñ‚Ð½Ð°Ñ ÑÐ²ÑÐ·ÑŒÂ»!"
    )

    keyboard = [
        [InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(
        faq_text,
        reply_markup=reply_markup,
        parse_mode="Markdown"
    )

async def support(update: Update, context: CallbackContext):
    query = update.callback_query
    await query.answer()

    support_text = (
        "ðŸ›  Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°:\n\n"
        "Ð•ÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ Ð²Ð¾Ð·Ð½Ð¸ÐºÐ»Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼ Ð¸Ð»Ð¸ Ð·Ð°ÐºÐ°Ð·Ð¾Ð¼, ÑÐ²ÑÐ¶Ð¸Ñ‚ÐµÑÑŒ Ñ Ð½Ð°Ð¼Ð¸:\n\n"
        "ðŸ“ž ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚: `+7 (914) 728-18-18`\n"
        "ðŸ“² Telegram: [Ð Ð°Ð±Ð¾Ñ‡Ð¸Ð¹ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚](https://t.me/+79953969908)\n"
        "ðŸ”— WhatsApp: [+7 914 728 18 18](https://wa.me/79147281818)\n"
        "ðŸ“¸ Instagram: [@svarkavl](https://www.instagram.com/svarkavl)\n"
        "ðŸ“ *2Ð“Ð˜Ð¡:* [ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð² 2Ð“Ð˜Ð¡](https://2gis.ru/vladivostok/geo/70000001076981081)\n\n"
        "ÐœÑ‹ Ð²ÑÐµÐ³Ð´Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ð¸ Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ Ð»ÑŽÐ±Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹! ðŸ˜Š"
    )

    keyboard = [[InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data='back_to_main')]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(
        support_text,
        reply_markup=reply_markup,
        parse_mode="Markdown",
        disable_web_page_preview=False
    )


async def main_menu_from_query(query):
    keyboard = [
        [InlineKeyboardButton("ðŸ“ Ð—ÐÐšÐÐ—ÐÐ¢Ð¬ Ð ÐÐ¡Ð§ÐÐ¢", callback_data='order')],
        [InlineKeyboardButton("ðŸ–¼ï¸ ÐŸÐ¾Ñ€Ñ‚Ñ„Ð¾Ð»Ð¸Ð¾", callback_data='gallery')],
        [InlineKeyboardButton("ðŸ¢ Ðž ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸", callback_data='about')],
        [InlineKeyboardButton("ðŸ“ž ÐžÐ±Ñ€Ð°Ñ‚Ð½Ð°Ñ ÑÐ²ÑÐ·ÑŒ", callback_data='feedback')],
        [InlineKeyboardButton("ðŸ›  Ð¢ÐµÑ…Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°", callback_data='support')],
        [InlineKeyboardButton("â“ FAQ", callback_data='faq')],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ€Ð°Ð·Ð´ÐµÐ»:", reply_markup=reply_markup)

# ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° Ð·Ð°ÐºÐ°Ð·Ð° ÐšÐŸ
async def start_order(update: Update, context: CallbackContext) -> int:
    context.user_data.clear()
    keyboard = [[InlineKeyboardButton(cat, callback_data=cat)] for cat in CATEGORIES.keys()]
    keyboard.append([InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data="back_to_main")])
    reply_markup = InlineKeyboardMarkup(keyboard)

    if update.callback_query:
        await update.callback_query.edit_message_text("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ:", reply_markup=reply_markup)
    else:
        await update.message.reply_text("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ:", reply_markup=reply_markup)
    
    return CATEGORY

# Ð’Ñ‹Ð±Ð¾Ñ€ Ð¿Ð¾Ð´ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸
async def choose_subcategory(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    category = query.data

    if category == "back_to_main":
        await main_menu_from_query(query)
        return ConversationHandler.END

    if category not in CATEGORIES:
        return await start_order(update, context)

    context.user_data["category"] = category
    await query.answer()

    if CATEGORIES[category]:
        keyboard = [[InlineKeyboardButton(sub, callback_data=f"sub_{sub}")] for sub in CATEGORIES[category]]
        keyboard.append([InlineKeyboardButton("Ð”Ñ€ÑƒÐ³Ð¾Ðµ", callback_data="other_subcategory")])
        keyboard.append([InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data="back_to_category")])
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð¾Ð´ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ:", reply_markup=reply_markup)
        return SUBCATEGORY
    else:
        return await ask_size(update, context)
    
async def handle_subcategory_selection(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    subcategory = query.data.replace("sub_", "")

    context.user_data["subcategory"] = subcategory
    await query.answer()
    
    return await ask_size(update, context)

async def back_to_category(update: Update, context: CallbackContext) -> int:
    await start_order(update, context)
    return CATEGORY

async def ask_size(update: Update, context: CallbackContext) -> int:
    if update.callback_query:
        query = update.callback_query
        if query.data == "back_to_category":
            return await back_to_category(update, context)
        await query.answer()

        keyboard = [
            [InlineKeyboardButton("Ð”Ð°", callback_data="yes"), InlineKeyboardButton("ÐÐµÑ‚", callback_data="no")],
            [InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data="back_to_category")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text("Ð—Ð½Ð°ÐµÑ‚Ðµ Ð»Ð¸ Ð²Ñ‹ Ñ€Ð°Ð·Ð¼ÐµÑ€?", reply_markup=reply_markup)
    elif update.message:
        keyboard = [
            [InlineKeyboardButton("Ð”Ð°", callback_data="yes"), InlineKeyboardButton("ÐÐµÑ‚", callback_data="no")],
            [InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data="back_to_category")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await update.message.reply_text("Ð—Ð½Ð°ÐµÑ‚Ðµ Ð»Ð¸ Ð²Ñ‹ Ñ€Ð°Ð·Ð¼ÐµÑ€?", reply_markup=reply_markup)

    return SIZE_KNOWN

# Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ
async def back_to_main(update: Update, context: CallbackContext):
    query = update.callback_query
    await query.answer()

    if 'photo_message_id' in context.user_data:
        try:
            await context.bot.delete_message(
                chat_id=query.message.chat_id,
                message_id=context.user_data['photo_message_id']
            )
            del context.user_data['photo_message_id']
        except Exception as e:
            print("âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° ÐºÐ°ÐºÐ°Ñ-Ñ‚Ð¾ Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð¼ [Ð² Telegram](https://t.me/+79953969908) Ð¾Ð± ÑÑ‚Ð¾Ð¼!!")
    await main_menu_from_query(query)
    return ConversationHandler.END

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ€Ðµ
async def handle_size_known(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()

    if query.data == "yes":
        return await ask_length(update, context)
    elif query.data == "no":
        context.user_data["length"] = "0"
        context.user_data["width"] = "0"
        return await ask_glass(update, context)
    elif query.data == "back_to_category":
        return await back_to_category(update, context)

# Ð•ÑÐ»Ð¸ Ð·Ð½Ð°ÐµÑ‚ Ñ€Ð°Ð·Ð¼ÐµÑ€, Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ Ð´Ð»Ð¸Ð½Ñƒ
async def ask_length(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()

    context.user_data["length_input"] = ""

    keyboard = generate_number_keyboard("length")
    keyboard.append([InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data="back_to_size_known")])
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ñ‹ÑÐ¾Ñ‚Ñƒ (Ð² Ð¼ÐµÑ‚Ñ€Ð°Ñ…) Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ ÐºÐ½Ð¾Ð¿Ð¾Ðº:", reply_markup=reply_markup)
    return LENGTH

async def back_to_size_known(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()
    return await ask_size(update, context)

async def handle_length_input(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()

    data = query.data.split("_")
    action = data[1]

    if action.isdigit():
        context.user_data["length_input"] += action
    elif action == "dot":
        if "." not in context.user_data["length_input"]:
            context.user_data["length_input"] += "."
    elif action == "clear":
        context.user_data["length_input"] = ""
    elif action == "done":
        if not context.user_data["length_input"] or context.user_data["length_input"] == ".":
            await query.answer("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾!", show_alert=True)
            return LENGTH
        context.user_data["length"] = context.user_data["length_input"]
        return await ask_width(update, context)

    keyboard = generate_number_keyboard("length", allow_dot="." not in context.user_data["length_input"])
    keyboard.append([InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data="back_to_size_known")])
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(f"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ñ‹ÑÐ¾Ñ‚Ñƒ (Ð² Ð¼ÐµÑ‚Ñ€Ð°Ñ…): {context.user_data['length_input']}", reply_markup=reply_markup)
    return LENGTH

def generate_number_keyboard(prefix: str, allow_dot: bool = True):
    keyboard = [
        [InlineKeyboardButton("1", callback_data=f"{prefix}_1"),
         InlineKeyboardButton("2", callback_data=f"{prefix}_2"),
         InlineKeyboardButton("3", callback_data=f"{prefix}_3")],
        [InlineKeyboardButton("4", callback_data=f"{prefix}_4"),
         InlineKeyboardButton("5", callback_data=f"{prefix}_5"),
         InlineKeyboardButton("6", callback_data=f"{prefix}_6")],
        [InlineKeyboardButton("7", callback_data=f"{prefix}_7"),
         InlineKeyboardButton("8", callback_data=f"{prefix}_8"),
         InlineKeyboardButton("9", callback_data=f"{prefix}_9")],
        [InlineKeyboardButton("0", callback_data=f"{prefix}_0"),
         InlineKeyboardButton("â¬…ï¸ ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ", callback_data=f"{prefix}_clear")]
    ]

    if allow_dot:
        keyboard[3].insert(1, InlineKeyboardButton(".", callback_data=f"{prefix}_dot"))

    keyboard.append([InlineKeyboardButton("âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾", callback_data=f"{prefix}_done")])

    return keyboard

async def ask_width(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()

    context.user_data["width_input"] = ""

    keyboard = generate_number_keyboard("width")
    keyboard.append([InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data="back_to_length")])
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑˆÐ¸Ñ€Ð¸Ð½Ñƒ (Ð² Ð¼ÐµÑ‚Ñ€Ð°Ñ…) Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ ÐºÐ½Ð¾Ð¿Ð¾Ðº:", reply_markup=reply_markup)
    return WIDTH

async def back_to_length(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()
    return await ask_length(update, context)

async def handle_width_input(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()

    data = query.data.split("_")
    action = data[1]

    if action.isdigit():
        context.user_data["width_input"] += action
    elif action == "dot":
        if "." not in context.user_data["width_input"]:
            context.user_data["width_input"] += "."
    elif action == "clear":
        context.user_data["width_input"] = ""
    elif action == "done":
        if not context.user_data["width_input"] or context.user_data["width_input"] == ".":
            await query.answer("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾!", show_alert=True)
            return WIDTH
        context.user_data["width"] = context.user_data["width_input"]
        return await ask_glass(update, context)

    keyboard = generate_number_keyboard("width", allow_dot="." not in context.user_data["width_input"])
    keyboard.append([InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data="back_to_length")])
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(f"Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑˆÐ¸Ñ€Ð¸Ð½Ñƒ (Ð² Ð¼ÐµÑ‚Ñ€Ð°Ñ…): {context.user_data['width_input']}", reply_markup=reply_markup)
    return WIDTH

async def ask_glass(update: Update, context: CallbackContext) -> int:
    if context.user_data.get("category") != "ÐŸÐµÑ€ÐµÐ³Ð¾Ñ€Ð¾Ð´ÐºÐ°":
        context.user_data["glass"] = "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾"
        return await ask_color(update, context)

    query = update.callback_query
    await query.answer()

    keyboard = [[InlineKeyboardButton(opt, callback_data=opt)] for opt in GLASS_OPTIONS]
    keyboard.append([InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data="back_to_size_known")])
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text("ÐšÐ°ÐºÐ¾Ðµ ÑÑ‚ÐµÐºÐ»Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ?", reply_markup=reply_markup)
    return GLASS

async def ask_color(update: Update, context: CallbackContext) -> int:
    if update.callback_query:
        query = update.callback_query
        context.user_data["glass"] = query.data
        await query.answer()
        send = query.edit_message_text
    else:
        send = update.message.reply_text

    keyboard = [[InlineKeyboardButton(opt, callback_data=opt)] for opt in COLOR_OPTIONS]
    keyboard.append([InlineKeyboardButton("Ð”Ñ€ÑƒÐ³Ð¾Ðµ", callback_data="other_color")])
    keyboard.append([InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data="back_to_glass")])
    reply_markup = InlineKeyboardMarkup(keyboard)

    await send("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ†Ð²ÐµÑ‚:", reply_markup=reply_markup)
    return COLOR


async def handle_color_selection(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    selected_option = query.data

    if selected_option in COLOR_OPTIONS:
        context.user_data["color"] = selected_option
    else:
        await query.answer("ÐžÑˆÐ¸Ð±ÐºÐ°: Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ†Ð²ÐµÑ‚ Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ°!", show_alert=True)
        return COLOR

    await query.answer()
    return await ask_phone_number(update, context)
    
async def back_to_glass(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()
    return await ask_glass(update, context)

async def ask_phone_number(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()

    keyboard = [
        [KeyboardButton("ðŸ“ž ÐŸÐ¾Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¾Ð¼", request_contact=True)],
        [KeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´")]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)

    await query.message.reply_text(
        "ÐŸÐ¾Ð´ÐµÐ»Ð¸Ñ‚ÐµÑÑŒ Ñ Ð½Ð°Ð¼Ð¸ Ð²Ð°ÑˆÐ¸Ð¼ Ð½Ð¾Ð¼ÐµÑ€Ð¾Ð¼ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¼Ñ‹ ÑÐ¼Ð¾Ð³Ð»Ð¸ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ð²Ð°Ð¼Ð¸:",
        reply_markup=reply_markup
    )
    return PHONE_NUMBER

async def handle_phone_number(update: Update, context: CallbackContext) -> int:
    if update.message.text and update.message.text.strip() == "ðŸ”™ ÐÐ°Ð·Ð°Ð´":
        await update.message.reply_text("Ð¥Ð¾Ñ€Ð¾ÑˆÐ¾, Ð²ÐµÑ€Ð½Ñ‘Ð¼ÑÑ Ðº Ð²Ñ‹Ð±Ð¾Ñ€Ñƒ Ñ†Ð²ÐµÑ‚Ð°!", reply_markup=ReplyKeyboardRemove())
        return await ask_color(update, context)

    if update.message.contact:
        phone_number = update.message.contact.phone_number

    elif update.message.text:
        phone_number = update.message.text.strip()
    else:
        await update.message.reply_text("ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°.")
        return PHONE_NUMBER

    context.user_data["phone_number"] = phone_number

    await update.message.reply_text(
        "Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾! Ð’Ð°Ñˆ Ð½Ð¾Ð¼ÐµÑ€ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½.",
        reply_markup=ReplyKeyboardRemove()
    )

    return await ask_source(update, context)



    
async def back_to_phone_number(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()
    return await ask_phone_number(update, context)

async def ask_source(update: Update, context: CallbackContext) -> int:
    keyboard = [[InlineKeyboardButton(opt, callback_data=opt)] for opt in SOURCE_OPTIONS]
    keyboard.append([InlineKeyboardButton("Ð”Ñ€ÑƒÐ³Ð¾Ðµ", callback_data="other_source")])
    keyboard.append([InlineKeyboardButton("ðŸ”™ ÐÐ°Ð·Ð°Ð´", callback_data="back_to_phone_number")])
    reply_markup = InlineKeyboardMarkup(keyboard)

    if update.callback_query:
        query = update.callback_query
        await query.answer()
        await query.edit_message_text("ÐžÑ‚ÐºÑƒÐ´Ð° ÑƒÐ·Ð½Ð°Ð»Ð¸ Ð¾ Ð½Ð°Ñ?", reply_markup=reply_markup)
    elif update.message:
        await update.message.reply_text("ÐžÑ‚ÐºÑƒÐ´Ð° ÑƒÐ·Ð½Ð°Ð»Ð¸ Ð¾ Ð½Ð°Ñ?", reply_markup=reply_markup)

    return SOURCE


async def handle_source_selection(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    selected_source = query.data 

    if selected_source in SOURCE_OPTIONS:
        context.user_data["source"] = selected_source
    else:
        await query.answer("ÐžÑˆÐ¸Ð±ÐºÐ°: Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð¸Ð· ÑÐ¿Ð¸ÑÐºÐ°!", show_alert=True)
        return SOURCE

    await query.answer()
    return await confirm_order(update, context)

async def back_to_color(update: Update, context: CallbackContext) -> int:
    if update.callback_query:
        await update.callback_query.answer()
        return await ask_color(update, context)
    elif update.message:
        return await ask_color(update, context)

async def handle_other_option(update: Update, context: CallbackContext, field: str, next_state: int, back_state: int) -> int:
    query = update.callback_query
    if query:
        await query.answer()
        await query.edit_message_text(f"ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÑÐ²Ð¾Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚:")
        return next_state

async def save_other_option(update: Update, context: CallbackContext, field: str, confirm_state: int) -> int:
    user_input = update.message.text.strip()
    if not user_input:
        await update.message.reply_text("ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ.")
        return confirm_state

    context.user_data[field] = user_input
    keyboard = [
        [InlineKeyboardButton("Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ", callback_data=f"confirm_{field}"),
        InlineKeyboardButton("ÐŸÐµÑ€ÐµÐ¿Ð¸ÑÐ°Ñ‚ÑŒ", callback_data=f"rewrite_{field}")]
    ]

    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        f"Ð’Ñ‹ Ð²Ð²ÐµÐ»Ð¸: {user_input}.\nÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚Ðµ Ð¸Ð»Ð¸ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚Ðµ:",
        reply_markup=reply_markup
    )
    return confirm_state

async def confirm_other_option(update: Update, context: CallbackContext, field: str, next_state: int, back_state: int) -> int:
    query = update.callback_query
    await query.answer()

    if query.data == f"rewrite_{field}":
        await query.edit_message_text(f"ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð¼ ÑÐ²Ð¾Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚!:")
        return back_state
    elif query.data == f"confirm_{field}":
        await query.edit_message_text("Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¾. ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ðº ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¼Ñƒ ÑˆÐ°Ð³Ñƒ.")
        return next_state

async def handle_other_subcategory(update: Update, context: CallbackContext) -> int:
    return await handle_other_option(update, context, "subcategory", OTHER_SUBCATEGORY, SUBCATEGORY)

async def save_other_subcategory(update: Update, context: CallbackContext) -> int:
    return await save_other_option(update, context, "subcategory", CONFIRM_SUBCATEGORY)

async def confirm_other_subcategory(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()
    
    if query.data == "confirm_subcategory":
        return await ask_size(update, context)
    elif query.data == "rewrite_subcategory":
        await query.edit_message_text("ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð¾Ð²ÑƒÑŽ Ð¿Ð¾Ð´ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ:")
        return OTHER_SUBCATEGORY

async def handle_other_color(update: Update, context: CallbackContext) -> int:
    return await handle_other_option(update, context, "color", OTHER_COLOR, COLOR)

async def save_other_color(update: Update, context: CallbackContext) -> int:
    return await save_other_option(update, context, "color", CONFIRM_COLOR)

async def confirm_other_color(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()
    
    if query.data == "confirm_color":
        return await ask_phone_number(update, context)
    elif query.data == "rewrite_color":
        await query.edit_message_text("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚:")
        return OTHER_COLOR

async def handle_other_source(update: Update, context: CallbackContext) -> int:
    return await handle_other_option(update, context, "source", OTHER_SOURCE, SOURCE)

async def save_other_source(update: Update, context: CallbackContext) -> int:
    return await save_other_option(update, context, "source", CONFIRM_SOURCE)

async def confirm_other_source(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()
    
    if query.data == "confirm_source":
        return await confirm_order(update, context)
    elif query.data == "rewrite_source":
        await query.edit_message_text("Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº:")
        return OTHER_SOURCE



async def confirm_order(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()

    category = context.user_data.get("category", "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾")
    subcategory = context.user_data.get("subcategory", "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾")
    length = context.user_data.get("length", "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾")
    width = context.user_data.get("width", "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾")
    glass = context.user_data.get("glass", "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾")
    color = context.user_data.get("color", "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾")
    source = context.user_data.get("source", "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾")
    phone_number = context.user_data.get("phone_number", "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾")

    order_summary = (f"ðŸ“Œ Ð’Ð°Ñˆ Ð·Ð°ÐºÐ°Ð·:\n\n"
                     f"ðŸ”¹ ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ: {category}\n"
                     f"ðŸ”¹ ÐŸÐ¾Ð´ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ: {subcategory}\n"
                     f"ðŸ“ Ð Ð°Ð·Ð¼ÐµÑ€Ñ‹:\n   - Ð’Ñ‹ÑÐ¾Ñ‚Ð°: {length} Ð¼\n   - Ð¨Ð¸Ñ€Ð¸Ð½Ð°: {width} Ð¼\n"
                     f"ðŸªŸ Ð¡Ñ‚ÐµÐºÐ»Ð¾: {glass}\n"
                     f"ðŸŽ¨ Ð¦Ð²ÐµÑ‚: {color}\n"
                     f"ðŸ“ž Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½: {phone_number}\n"
                     f"ðŸ“ Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº: {source}\n\n"
                     f"âœ… ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚Ðµ Ð¸Ð»Ð¸ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð·Ð°ÐºÐ°Ð·:")

    keyboard = [
        [InlineKeyboardButton("âœ… ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ", callback_data="confirm_send")],
        [InlineKeyboardButton("âœï¸ Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ", callback_data="confirm_edit")],
        [InlineKeyboardButton("ðŸ  Ð’ Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ", callback_data="confirm_cancel")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(order_summary, reply_markup=reply_markup, parse_mode="Markdown")
    return CONFIRM_ORDER

async def handle_confirm_order(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()

    if query.data == "confirm_send":
        return await complete_order(update, context) 

    elif query.data == "confirm_edit":
        return await start_order(update, context) 

    elif query.data == "confirm_cancel":
        await main_menu_from_query(query) 
        return ConversationHandler.END

async def complete_order(update: Update, context: CallbackContext) -> int:
    access_token = get_access_token()
    if not access_token:
        if update.callback_query:
            await update.callback_query.message.reply_text("âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° ÐºÐ°ÐºÐ°Ñ-Ñ‚Ð¾ Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð¼ [Ð² Telegram](https://t.me/+79953969908) Ð¾Ð± ÑÑ‚Ð¾Ð¼!!")
        else:
            await update.message.reply_text("âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° ÐºÐ°ÐºÐ°Ñ-Ñ‚Ð¾ Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð¼ [Ð² Telegram](https://t.me/+79953969908) Ð¾Ð± ÑÑ‚Ð¾Ð¼!!")
        return ConversationHandler.END

    tokens.default_token_manager(
        client_id=Config.CLIENT_ID,
        client_secret=Config.CLIENT_SECRET,
        subdomain=Config.SUBDOMAIN,
        redirect_url=Config.REDIRECT_URI,
        storage=tokens.FileTokensStorage()
    )

    class CustomLead(_Lead):
        category = custom_field.TextCustomField("ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ")
        subcategory = custom_field.TextCustomField("ÐŸÐ¾Ð´ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ")
        length = custom_field.NumericCustomField("Ð’Ñ‹ÑÐ¾Ñ‚Ð°")
        width = custom_field.NumericCustomField("Ð¨Ð¸Ñ€Ð¸Ð½Ð°")
        glass = custom_field.TextCustomField("Ð¡Ñ‚ÐµÐºÐ»Ð¾")
        color = custom_field.TextCustomField("Ð¦Ð²ÐµÑ‚")
        phone_number = custom_field.TextCustomField("ÐÐ¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°")
        source = custom_field.TextCustomField("ÐžÑ‚ÐºÑƒÐ´Ð° ÑƒÐ·Ð½Ð°Ð»Ð¸ Ð¾ Ð½Ð°Ñ")

    if update.callback_query:
        query = update.callback_query
        await query.answer()
        chat_id = query.message.chat_id
        message_sender = query.message.reply_text
    elif update.message:
        chat_id = update.message.chat_id
        message_sender = update.message.reply_text
    else:
        print("âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° ÐºÐ°ÐºÐ°Ñ-Ñ‚Ð¾ Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð¼ [Ð² Telegram](https://t.me/+79953969908) Ð¾Ð± ÑÑ‚Ð¾Ð¼!!")
        return ConversationHandler.END
    
    query = update.callback_query
    await query.answer()
    await query.edit_message_text("â³ ÐŸÐ¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ Ð¼Ð¸Ð½ÑƒÑ‚Ð¾Ñ‡ÐºÑƒ, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð»Ñ Ð²Ð°Ñ Ð½Ð¾Ð²ÑƒÑŽ ÑÐ´ÐµÐ»ÐºÑƒ...")

    

    pipeline = Pipeline.objects.get(Config.PIPELINE_ID)

    status = next((s for s in pipeline.statuses if s.id == Config.STATUS_ID), None)

    try:
        length = float(context.user_data.get("length", 0) or 0)
        width = float(context.user_data.get("width", 0) or 0)

        glass = context.user_data.get("glass", "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾")
        if glass not in GLASS_OPTIONS and glass != "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾":
            glass = "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾"

        lead = CustomLead(
            name=f"Ð—Ð°ÐºÐ°Ð· Ð¾Ñ‚ Telegram ({chat_id})",
            price=0,
            pipeline=pipeline,
            status=status,
            category=context.user_data.get("category", "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾"),
            subcategory=context.user_data.get("subcategory", "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾"),
            length=length,
            width=width,  
            glass=glass,
            color=context.user_data.get("color", "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾"),
            phone_number=context.user_data.get("phone_number", "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾"),
            source=context.user_data.get("source", "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾"),
        )

        lead.save()

        order_summary = (
            f"ðŸ“Œ *ÐÐ¾Ð²Ð°Ñ ÑÐ´ÐµÐ»ÐºÐ° Ð² AmoCRM*:\n\n"
            f"ðŸ”¹ *ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ:* {context.user_data.get('category', 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾')}\n"
            f"ðŸ”¹ *ÐŸÐ¾Ð´ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ:* {context.user_data.get('subcategory', 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾')}\n"
            f"ðŸ“ *Ð Ð°Ð·Ð¼ÐµÑ€Ñ‹:*\n"
            f"   - *Ð’Ñ‹ÑÐ¾Ñ‚Ð°:* {length} Ð¼\n"
            f"   - *Ð¨Ð¸Ñ€Ð¸Ð½Ð°:* {width} Ð¼\n"
            f"ðŸªŸ *Ð¡Ñ‚ÐµÐºÐ»Ð¾:* {glass}\n"
            f"ðŸŽ¨ *Ð¦Ð²ÐµÑ‚:* {context.user_data.get('color', 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾')}\n"
            f"ðŸ“ž *Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:* {context.user_data.get('phone_number', 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾')}\n"
            f"ðŸ“ *Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº:* {context.user_data.get('source', 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾')}\n\n"
            f"âœ… *ID ÑÐ´ÐµÐ»ÐºÐ¸:* {lead.id}\n"
            f"--------------------------------------"
        )

        await context.bot.send_message(
            chat_id=Config.SUPPORT_CHAT_ID,
            text=order_summary,
            parse_mode="Markdown"
        )

        
        keyboard = [[InlineKeyboardButton("ðŸ  Ð’ÐµÑ€Ð½ÑƒÑ‚ÑŒÑÑ Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ", callback_data="back_to_main")]]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.edit_message_text(
            text=f"âœ… Ð¡Ð´ÐµÐ»ÐºÐ° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð°: {lead.id}!!\nÐ¡ÐµÐ¹Ñ‡Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽ Ñ Ð´Ñ€ÑƒÐ³Ð¸Ð¼ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð¼, ÐºÐ°Ðº Ð¾ÑÐ²Ð¾Ð±Ð¾Ð¶ÑƒÑÑŒ, Ð´Ð°Ð¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ!",
            reply_markup=reply_markup
        )

    except Exception as e:
        print("âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° ÐºÐ°ÐºÐ°Ñ-Ñ‚Ð¾ Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð¼ [Ð² Telegram](https://t.me/+79953969908) Ð¾Ð± ÑÑ‚Ð¾Ð¼!!")
        await message_sender("âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° ÐºÐ°ÐºÐ°Ñ-Ñ‚Ð¾ Ð¾ÑˆÐ¸Ð±ÐºÐ°, Ð½Ð°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð½Ð°Ð¼ [Ð² Telegram](https://t.me/+79953969908) Ð¾Ð± ÑÑ‚Ð¾Ð¼!!")

    return ConversationHandler.END

async def cancel_order_and_show_menu(update: Update, context: CallbackContext):
    context.user_data.clear()

    if update.effective_chat.id in context.application.conversations:
        context.application.conversations[update.effective_chat.id].cancel()

    await main_menu(update, context)
    return ConversationHandler.END

async def cancel_order_and_show_menu(update: Update, context: CallbackContext):
    context.user_data.clear()

    if context.chat_data.get("conversation"):
        context.chat_data["conversation"].update_state(None)

    return await main_menu(update, context)


async def handle_text(update: Update, context: CallbackContext):
    text = update.message.text.lower()

    if text == "Ð¼ÐµÐ½ÑŽ":
        context.user_data.clear()
        await cancel_order_and_show_menu(update, context)
    else:
        await update.message.reply_text("Ð˜Ð·Ð²Ð¸Ð½Ð¸Ñ‚Ðµ, Ñ Ð½Ðµ Ð¿Ð¾Ð½Ð¸Ð¼Ð°ÑŽ ÑÑ‚Ð¾Ñ‚ Ð·Ð°Ð¿Ñ€Ð¾Ñ. ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ \"Ð¼ÐµÐ½ÑŽ\", Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ.")
    
    return ConversationHandler.END

def main() -> None:
    application = ApplicationBuilder().token(Config.BOT_TOKEN).build()

    application.add_handler(CommandHandler('start', cancel_order_and_show_menu))
    application.add_handler(CommandHandler('menu', cancel_order_and_show_menu))

    application.add_handler(CallbackQueryHandler(about_company, pattern='^about$'))
    application.add_handler(CallbackQueryHandler(gallery, pattern='^gallery$'))
    application.add_handler(CallbackQueryHandler(feedback, pattern='^feedback$'))
    application.add_handler(CallbackQueryHandler(faq, pattern='^faq$'))
    application.add_handler(CallbackQueryHandler(back_to_main, pattern='^back_to_main$'))
    application.add_handler(CallbackQueryHandler(handle_photo_navigation, pattern='^(prev_photo|next_photo|back_to_main)$'))
    application.add_handler(CallbackQueryHandler(support, pattern='^support$'))

    order_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(start_order, pattern="^order$")],
        states={
            CATEGORY: [CallbackQueryHandler(choose_subcategory)],

            SUBCATEGORY: [
                CallbackQueryHandler(handle_subcategory_selection, pattern="^sub_.*$"),
                CallbackQueryHandler(ask_size, pattern="^(?!back_to_category|other_subcategory).*$"),
                CallbackQueryHandler(back_to_category, pattern="^back_to_category$"),
                CallbackQueryHandler(handle_other_subcategory, pattern="^other_subcategory$")
            ],
            OTHER_SUBCATEGORY: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_other_subcategory)],
            CONFIRM_SUBCATEGORY: [
                CallbackQueryHandler(confirm_other_subcategory, pattern="^(rewrite_subcategory|confirm_subcategory)$")
            ],

            SIZE_KNOWN: [CallbackQueryHandler(handle_size_known, pattern="^(yes|no|back_to_category)$")],
            LENGTH: [
                CallbackQueryHandler(handle_length_input, pattern="^length_.*$"),
                CallbackQueryHandler(back_to_size_known, pattern="^back_to_size_known$")
            ],
            WIDTH: [
                CallbackQueryHandler(handle_width_input, pattern="^width_.*$"),
                CallbackQueryHandler(back_to_length, pattern="^back_to_length$")
            ],

            GLASS: [
                CallbackQueryHandler(ask_color, pattern="^(?!back_to_size_known).*$"),
                CallbackQueryHandler(back_to_size_known, pattern="^back_to_size_known$")
            ],

            COLOR: [
                CallbackQueryHandler(handle_color_selection, pattern="^(?!back_to_glass|upload|skip|other_color).*$"),
                CallbackQueryHandler(back_to_glass, pattern="^back_to_glass$"),
                CallbackQueryHandler(handle_other_color, pattern="^other_color$")
            ],
            OTHER_COLOR: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_other_color)],
            CONFIRM_COLOR: [
                CallbackQueryHandler(confirm_other_color, pattern="^(rewrite_color|confirm_color)$")
            ],

            PHONE_NUMBER: [MessageHandler(filters.ALL, handle_phone_number)],
            
            SOURCE: [CallbackQueryHandler(handle_source_selection, pattern="^(?!back_to_phone_number|other_source).*$"),
                     CallbackQueryHandler(back_to_phone_number, pattern="^back_to_phone_number$"),
                     CallbackQueryHandler(handle_other_source, pattern="^other_source$")],
            OTHER_SOURCE: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_other_source)],
            CONFIRM_SOURCE: [CallbackQueryHandler(confirm_other_source, pattern="^(rewrite_source|confirm_source)$")],
            CONFIRM_ORDER: [CallbackQueryHandler(handle_confirm_order, pattern="^(confirm_send|confirm_edit|confirm_cancel)$")]
        },
        fallbacks=[],
        per_user=True
    )

    application.add_handler(order_handler)
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
    application.run_polling()
    

if __name__ == '__main__':
    main()

